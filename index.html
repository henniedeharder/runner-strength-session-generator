<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- Make it usable on phones -->
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Runner Strength Training Generator</title>
  <style>
    :root {
      --bg: #0b1020;
      --card-bg: #14192b;
      --accent: #4fd1c5;
      --accent-soft: rgba(79, 209, 197, 0.12);
      --accent-strong: #38b2ac;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --danger: #f97373;
      --border: #1f2937;
      --radius: 10px;
      --shadow-soft: 0 12px 30px rgba(0, 0, 0, 0.45);
    }

    body[data-theme="light"] {
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --accent: #0f766e;
      --accent-soft: rgba(15, 118, 110, 0.08);
      --accent-strong: #0d9488;
      --text-main: #111827;
      --text-muted: #6b7280;
      --danger: #b91c1c;
      --border: #e5e7eb;
      --shadow-soft: 0 10px 24px rgba(15, 23, 42, 0.12);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1f2937 0, #020617 55%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
      transition: background 0.25s ease, color 0.25s ease;
      font-size: 16px;
    }

    body[data-theme="light"] {
      background: radial-gradient(circle at top, #e5e7eb 0, #f3f4f6 55%);
    }

    .page {
      width: 100%;
      max-width: 1200px;
      padding: 30px 18px;
    }

    .header {
      text-align: center;
      margin-bottom: 24px;
      position: relative;
    }

    .title {
      font-size: 1.9rem;
      margin: 0;
      letter-spacing: 0.03em;
    }

    .title span {
      color: var(--accent);
    }

    .subtitle {
      margin-top: 8px;
      font-size: 0.95rem;
      color: var(--text-muted);
    }

    .header-controls {
      position: absolute;
      right: 0;
      top: 0;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .theme-toggle,
    .layout-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      user-select: none;
    }

    .theme-toggle input,
    .layout-toggle input {
      display: none;
    }

    .theme-switch {
      width: 38px;
      height: 20px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.4);
      border: 1px solid rgba(148, 163, 184, 0.8);
      position: relative;
      transition: background 0.2s, border-color 0.2s;
    }

    .theme-knob {
      position: absolute;
      top: 1px;
      left: 1px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #f9fafb;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.5);
      transition: transform 0.2s ease;
    }

    #themeToggle:checked + .theme-switch .theme-knob {
      transform: translateX(18px);
    }

    #themeToggle:checked + .theme-switch {
      background: var(--accent-soft);
      border-color: var(--accent);
    }

    .layout-pill {
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.7);
      color: var(--text-muted);
      font-size: 0.75rem;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    body[data-theme="light"] .layout-pill {
      background: #f9fafb;
      border-color: #d1d5db;
    }

    .layout-pill span {
      font-weight: 500;
      color: var(--text-main);
    }

    body[data-layout="stacked"] .layout-pill span {
      color: var(--accent-strong);
    }

    .shell {
      display: grid;
      grid-template-columns: minmax(0, 0.9fr) minmax(0, 1.6fr);
      grid-template-areas: "setup results";
      gap: 20px;
    }

    .setup-card {
      grid-area: setup;
    }

    .results-card {
      grid-area: results;
    }

    body[data-layout="stacked"] .shell {
      grid-template-columns: 1fr;
      grid-template-areas:
        "setup"
        "results";
    }

    @media (max-width: 900px) {
      body[data-layout="wide"] .shell {
        grid-template-columns: 1fr;
        grid-template-areas:
          "setup"
          "results";
      }

      .page {
        padding: 18px 12px;
      }

      .header-controls {
        position: static;
        margin-top: 10px;
        align-items: center;
      }
    }

    @media (max-width: 480px) {
      body {
        font-size: 14px;
      }

      .title {
        font-size: 1.5rem;
      }

      .btn {
        padding: 8px 12px;
        font-size: 0.85rem;
      }

      .card {
        padding: 14px 12px 16px;
      }
    }

    .card {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.9));
      border-radius: var(--radius);
      border: 1px solid rgba(148, 163, 184, 0.15);
      box-shadow: var(--shadow-soft);
      padding: 18px 18px 20px;
      position: relative;
      overflow: hidden;
      transition: background 0.25s ease, border-color 0.25s ease, box-shadow 0.25s ease;
    }

    body[data-theme="light"] .card {
      background: linear-gradient(135deg, #ffffff, #f9fafb);
      border-color: #e5e7eb;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -60%;
      background: radial-gradient(circle at top left, rgba(79, 209, 197, 0.16), transparent 55%);
      opacity: 0.5;
      pointer-events: none;
    }

    .card-inner {
      position: relative;
      z-index: 1;
    }

    .card-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .card-title h2 {
      margin: 0;
      font-size: 1.1rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    body[data-theme="light"] .card-title h2 {
      color: #111827;
    }

    .card-badge {
      font-size: 0.75rem;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(79, 209, 197, 0.14);
      color: var(--accent);
      border: 1px solid rgba(79, 209, 197, 0.4);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .inputs-column {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 12px;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      background: rgba(15, 23, 42, 0.8);
      border-radius: 8px;
      padding: 10px 10px 9px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      transition: border-color 0.2s, box-shadow 0.2s, transform 0.1s, opacity 0.2s, background 0.25s ease;
    }

    body[data-theme="light"] .input-group {
      background: #f9fafb;
      border-color: #e5e7eb;
    }

    .input-group:hover {
      border-color: rgba(79, 209, 197, 0.6);
      box-shadow: 0 0 0 1px rgba(79, 209, 197, 0.2);
      transform: translateY(-1px);
    }

    .input-group-header {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .input-toggle {
      border: none;
      background: transparent;
      color: inherit;
      cursor: pointer;
      padding: 0 4px 0 0;
      font-size: 0.8rem;
    }

    label {
      font-size: 0.9rem;
      font-weight: 600;
      color: #e5e7eb;
      margin-bottom: 4px;
    }

    body[data-theme="light"] label {
      color: #111827;
    }

    .hint {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-top: 3px;
    }

    .hint span {
      color: var(--accent);
    }

    input[type="number"] {
      margin-top: 4px;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.8);
      color: var(--text-main);
      font-size: 0.9rem;
      max-width: 160px;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s, background 0.2s ease, color 0.2s ease;
    }

    body[data-theme="light"] input[type="number"] {
      background: #ffffff;
      border-color: #d1d5db;
      color: #111827;
    }

    input[type="number"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(79, 209, 197, 0.4);
    }

    .tip {
      margin-bottom: 12px;
      font-size: 0.8rem;
      color: var(--text-muted);
      background: linear-gradient(90deg, rgba(79, 209, 197, 0.12), transparent);
      border-radius: 7px;
      padding: 7px 9px;
      border: 1px solid rgba(79, 209, 197, 0.2);
    }

    .tip strong {
      color: var(--accent-strong);
    }

    .controls-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-top: 4px;
      flex-wrap: wrap;
    }

    .error {
      color: var(--danger);
      font-size: 0.85rem;
      font-weight: 500;
      display: none;
      margin-bottom: 4px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 9px 16px;
      border-radius: 999px;
      border: 1px solid rgba(15, 23, 42, 0.9);
      background: radial-gradient(circle at top left, var(--accent), var(--accent-strong));
      color: #0b1020;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      box-shadow: 0 10px 22px rgba(56, 178, 172, 0.35);
      transition: transform 0.11s ease-out, box-shadow 0.11s ease-out, background 0.2s;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 28px rgba(56, 178, 172, 0.45);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: 0 6px 14px rgba(56, 178, 172, 0.4);
    }

    .btn-secondary {
      background: transparent;
      color: var(--text-muted);
      border-color: rgba(148, 163, 184, 0.3);
      box-shadow: none;
      text-transform: none;
      letter-spacing: 0.02em;
      padding: 6px 10px;
      font-size: 0.8rem;
    }

    .btn-secondary:hover {
      border-color: rgba(148, 163, 184, 0.6);
      color: #e5e7eb;
      transform: none;
    }

    body[data-theme="light"] .btn-secondary:hover {
      color: #111827;
    }

    .btn-icon {
      font-size: 1.05rem;
    }

    .btn-small {
      padding: 6px 10px;
      font-size: 0.8rem;
      box-shadow: 0 6px 14px rgba(56, 178, 172, 0.25);
    }

    .muted {
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    .dimmed {
      opacity: 0.5;
    }

    .per-category-group {
      position: relative;
      cursor: grab;
    }

    .per-category-group.drag-over {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(79, 209, 197, 0.4);
    }

    /* Collapse behavior for exercise library in setup */
    .input-group.collapsed .input-library-list,
    .input-group.collapsed .inline-hover-detail {
      display: none;
    }

    .results-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
      flex-wrap: wrap;
    }

    .results-header h2 {
      margin: 0;
      font-size: 1.08rem;
    }

    .results-summary-line {
      font-size: 0.82rem;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .results-right-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .results-meta {
      font-size: 0.82rem;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .results-meta span {
      color: var(--accent);
      font-weight: 500;
    }

    .results-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .category-block {
      background: rgba(15, 23, 42, 0.88);
      border-radius: 9px;
      padding: 10px 12px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      position: relative;
      transition: background 0.25s ease, border-color 0.25s ease;
    }

    body[data-theme="light"] .category-block {
      background: #ffffff;
      border-color: #e5e7eb;
    }

    .category-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
      gap: 6px;
    }

    .category-name {
      font-size: 0.9rem;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: #d1d5db;
    }

    body[data-theme="light"] .category-name {
      color: #111827;
    }

    .category-pill {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.12);
      color: var(--text-muted);
      white-space: nowrap;
    }

    .category-empty {
      font-size: 0.8rem;
      color: var(--text-muted);
      font-style: italic;
      padding-top: 2px;
    }

    .exercise-list {
      margin: 0;
      padding-left: 0;
      list-style: none;
    }

    .exercise-item {
      font-size: 0.86rem;
      padding: 3px 0;
      border-top: 1px dashed rgba(55, 65, 81, 0.7);
      display: flex;
      align-items: baseline;
      gap: 6px;
    }

    .exercise-item:first-child {
      border-top: none;
    }

    .exercise-checkbox {
      margin-top: 0;
      align-self: baseline;
      accent-color: var(--accent);
      cursor: pointer;
    }

    .exercise-content {
      flex: 1;
    }

    .exercise-main {
      font-weight: 500;
      color: #e5e7eb;
    }

    body[data-theme="light"] .exercise-main {
      color: #111827;
    }

    .exercise-detail {
      display: block;
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-left: 2px;
      margin-top: 1px;
    }

    .exercise-tags {
      margin-left: 4px;
    }

    .exercise-tag {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0 6px;
      border-radius: 999px;
      font-size: 0.72rem;
      border: 1px solid rgba(79, 209, 197, 0.4);
      color: var(--accent);
      margin-left: 2px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      cursor: default;
      background: rgba(15, 23, 42, 0.6);
    }

    body[data-theme="light"] .exercise-tag {
      background: rgba(209, 250, 229, 0.7);
    }

    .exercise-tag[data-tooltip]::after {
      content: attr(data-tooltip);
      position: absolute;
      left: 50%;
      bottom: 135%;
      transform: translateX(-50%);
      max-width: 380px;
      background: #020617;
      color: #e5e7eb;
      padding: 5px 7px;
      border-radius: 6px;
      white-space: normal;
      font-size: 0.7rem;
      opacity: 0;
      pointer-events: none;
      border: 1px solid rgba(148, 163, 184, 0.6);
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.9);
      transition: opacity 0.12s ease-out, transform 0.12s ease-out;
      z-index: 50;
    }

    .exercise-tag[data-tooltip]::before {
      content: "";
      position: absolute;
      left: 50%;
      bottom: 125%;
      transform: translateX(-50%);
      border-width: 5px;
      border-style: solid;
      border-color: #020617 transparent transparent transparent;
      opacity: 0;
      transition: opacity 0.12s ease-out;
      z-index: 51;
    }

    body[data-theme="light"] .exercise-tag[data-tooltip]::after {
      background: #ffffff;
      color: #111827;
      border-color: rgba(148, 163, 184, 0.8);
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.15);
    }

    body[data-theme="light"] .exercise-tag[data-tooltip]::before {
      border-color: #ffffff transparent transparent transparent;
    }

    .exercise-tag[data-tooltip]:hover::after {
      opacity: 1;
      transform: translateX(-50%) translateY(-2px);
    }

    .exercise-tag[data-tooltip]:hover::before {
      opacity: 1;
    }

    .exercise-item.done .exercise-main,
    .exercise-item.done .exercise-detail {
      text-decoration: line-through;
      color: rgba(148, 163, 184, 0.7);
    }

    .legend {
      margin-top: 10px;
      font-size: 0.78rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .legend span {
      white-space: nowrap;
    }

    .legend strong {
      color: #e5e7eb;
    }

    body[data-theme="light"] .legend strong {
      color: #111827;
    }

    /* Inline exercise list in setup */

    .input-library-list {
      margin: 6px 0 0;
      padding-left: 0;
      list-style: none;
      max-height: none;
      overflow-y: visible;
      border-radius: 6px;
      background: rgba(15, 23, 42, 0.75);
      border: 1px solid rgba(31, 41, 55, 0.9);
    }

    body[data-theme="light"] .input-library-list {
      background: #ffffff;
      border-color: #e5e7eb;
    }

    .input-library-item {
      font-size: 0.8rem;
      padding: 4px 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      transition: background 0.15s, transform 0.1s;
    }

    .input-library-item:nth-child(odd) {
      background: rgba(15, 23, 42, 0.3);
    }

    body[data-theme="light"] .input-library-item:nth-child(odd) {
      background: #f9fafb;
    }

    .input-library-item:hover {
      background: rgba(79, 209, 197, 0.16);
      transform: translateY(-1px);
    }

    .input-library-name {
      font-weight: 500;
    }

    .input-library-tags {
      font-size: 0.7rem;
      color: var(--accent);
      white-space: nowrap;
    }

    .inline-hover-detail {
      margin-top: 4px;
      padding: 6px 7px;
      border-radius: 6px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.4);
      font-size: 0.76rem;
    }

    body[data-theme="light"] .inline-hover-detail {
      background: #f9fafb;
      border-color: #e5e7eb;
    }

    .inline-hover-title {
      font-weight: 600;
      margin-bottom: 1px;
    }

    .inline-hover-meta {
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .inline-hover-note {
      color: var(--text-main);
    }

    .exercise-remove {
      margin-left: 6px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 0.8rem;
      cursor: pointer;
      padding: 0 4px;
      border-radius: 999px;
      transition: background 0.15s, color 0.15s;
    }

    .exercise-remove:hover {
      background: rgba(248, 113, 113, 0.14);
      color: var(--danger);
    }

    .category-header-right {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .category-regenerate {
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 0.85rem;
      cursor: pointer;
      padding: 4px 6px;
      border-radius: 999px;
      transition: background 0.15s, color 0.15s;
    }

    .category-regenerate:hover {
      background: rgba(79, 209, 197, 0.16);
      color: var(--accent-strong);
    }

    .exercise-pin {
      border: none;
      background: transparent;
      color: var(--accent);
      font-size: 0.9rem;
      cursor: pointer;
      padding: 2px 6px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s, color 0.15s;
    }

    .exercise-pin:hover {
      background: rgba(79, 209, 197, 0.16);
    }

    .exercise-item.pinned .exercise-main {
      color: var(--accent-strong);
    }

    .exercise-main-line {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      flex-wrap: wrap;
    }

    .exercise-text-wrap {
      display: flex;
      align-items: baseline;        /* Keep name + (desktop) tags on same baseline */
      gap: 4px;
      flex: 1 1 auto;
      min-width: 0;
    }

    .exercise-actions {
      display: inline-flex;
      align-items: baseline;        /* Star + X line up with text baseline */
      gap: 4px;
      flex: 0 0 auto;
    }

    .load-session-bar {
      margin: 6px 0 8px;
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
      font-size: 0.8rem;
    }

    .load-session-bar select {
      min-width: 180px;
      max-width: 100%;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      font-size: 0.8rem;
    }

    body[data-theme="light"] .load-session-bar select {
      background: #ffffff;
      color: #111827;
      border-color: #d1d5db;
    }

    .category-tip {
      margin-top: 4px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    /* Hide tip when the group is collapsed, so "below" doesn't show with nothing below */
    .input-group.collapsed .category-tip {
      display: none;
    }

    /* Mobile tweaks: keep text on the left, controls grouped on the right or stacked */
    @media (max-width: 600px) {
      .exercise-main-line {
        flex-wrap: wrap;
        align-items: baseline;      /* Still baseline on mobile */
        gap: 4px;
      }

      .exercise-text-wrap {
        flex: 1 1 auto;
        min-width: 0;
      }

      .exercise-main {
        white-space: normal;
      }

      .exercise-actions {
        flex: 0 0 auto;
        display: inline-flex;
        flex-direction: row;        /* Keep star + X side-by-side */
        align-items: baseline;
        justify-content: flex-end;
        gap: 4px;
        white-space: nowrap;        /* Prevent them from wrapping separately */
      }

      .exercise-pin,
      .exercise-remove {
        min-width: 32px;
        min-height: 32px;
        padding: 2px 6px;
      }

      /* You already added this, but keeping it here for completeness:
        hide tags on mobile to reduce clutter. */
      .exercise-tags {
        display: none;
      }

      .layout-toggle {
        display: none;
      }
    }

    .mobile-action-bar {
      display: none;
    }

    @media (max-width: 600px) {
      .mobile-action-bar {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        padding: 8px 12px calc(8px + env(safe-area-inset-bottom));
        background: rgba(15, 23, 42, 0.95);
        border-top: 1px solid rgba(148, 163, 184, 0.4);
        display: flex;
        gap: 8px;
        justify-content: space-between;
        z-index: 100;
      }

      body[data-theme="light"] .mobile-action-bar {
        background: rgba(249, 250, 251, 0.97);
        border-top-color: #e5e7eb;
      }

      /* Prevent content from being hidden behind the bar */
      .page {
        padding-bottom: 80px;
      }

      /* Bigger tap targets on mobile */
      .btn,
      .btn-small {
        min-height: 44px;
      }

      .exercise-pin,
      .exercise-remove,
      .category-regenerate {
        min-width: 40px;
        min-height: 40px;
      }
    }
  </style>
</head>
<body data-theme="dark">
  <div class="page">
    <header class="header">
      <h1 class="title">
        Runner <span>Strength Session</span> Designer
      </h1>
      <div class="header-controls">
        <label class="theme-toggle">
          <span id="themeLabel">Dark</span>
          <input type="checkbox" id="themeToggle" />
          <div class="theme-switch">
            <div class="theme-knob"></div>
          </div>
        </label>
        <label class="layout-toggle">
          <div class="layout-pill">
            Layout: <span id="layoutLabel">Stacked</span>
          </div>
          <input type="checkbox" id="layoutToggle" />
        </label>
      </div>
      <p class="subtitle">
        Build lower-body and core strength sessions tailored to your running.
      </p>
    </header>

    <main class="shell">
      <!-- LEFT: INPUTS -->
      <section class="card setup-card">
        <div class="card-inner">
          <div class="card-title">
            <h2>Setup</h2>
          </div>

          <p class="tip">
            <strong>How it works:</strong>
            Set the number of exercises per category and click <strong>Generate workout</strong>.
            You can click any exercise to add it, and drag category cards to change their order.
          </p>

          <div id="error" class="error"></div>

          <div class="controls-row">
            <button id="generateBtn" class="btn">
              <span class="btn-icon">âš¡</span>
              Generate workout
            </button>
            <button id="presetBtn" class="btn btn-secondary" type="button">
              Use runner preset
            </button>
            <div>
              <br><br>
            </div>
          </div>

          <div class="inputs-column" id="inputsColumn">
            <!-- Per category inputs (draggable) with collapsible libraries -->
            <div
              class="input-group per-category-group collapsed"
              id="drillsGroup"
              data-category="drills"
              draggable="true"
            >
              <div class="input-group-header">
                <button class="input-toggle" type="button">â–¶</button>
                <label for="drillsInput">Drills / Prehab</label>
              </div>
              <input id="drillsInput" type="number" min="0" max="3" value="2" />
              <p class="category-tip">
                Tip: click an exercise below to add it directly to today's session.
              </p>
              <ul class="input-library-list" data-category-library="drills"></ul>
              <div class="inline-hover-detail" data-hover-detail="drills" style="display:none;"></div>
            </div>

            <div
              class="input-group per-category-group collapsed"
              id="plyoGroup"
              data-category="plyo"
              draggable="true"
            >
              <div class="input-group-header">
                <button class="input-toggle" type="button">â–¶</button>
                <label for="plyoInput">Plyometric</label>
              </div>
              <input id="plyoInput" type="number" min="0" max="4" value="1" />
              <p class="category-tip">
                Tip: click an exercise below to add it directly to today's session.
              </p>
              <ul class="input-library-list" data-category-library="plyo"></ul>
              <div class="inline-hover-detail" data-hover-detail="plyo" style="display:none;"></div>
            </div>

            <div
              class="input-group per-category-group collapsed"
              id="squatGroup"
              data-category="squat"
              draggable="true"
            >
              <div class="input-group-header">
                <button class="input-toggle" type="button">â–¶</button>
                <label for="squatInput">Squat</label>
              </div>
              <input id="squatInput" type="number" min="0" max="1" value="1" />
              <p class="category-tip">
                Tip: click an exercise below to add it directly to today's session.
              </p>
              <ul class="input-library-list" data-category-library="squat"></ul>
              <div class="inline-hover-detail" data-hover-detail="squat" style="display:none;"></div>
            </div>

            <div
              class="input-group per-category-group collapsed"
              id="hingeGroup"
              data-category="hinge"
              draggable="true"
            >
              <div class="input-group-header">
                <button class="input-toggle" type="button">â–¶</button>
                <label for="hingeInput">Hinge</label>
              </div>
              <input id="hingeInput" type="number" min="0" max="5" value="2" />
              <p class="category-tip">
                Tip: click an exercise below to add it directly to today's session.
              </p>
              <ul class="input-library-list" data-category-library="hinge"></ul>
              <div class="inline-hover-detail" data-hover-detail="hinge" style="display:none;"></div>
            </div>

            <div
              class="input-group per-category-group collapsed"
              id="lungeGroup"
              data-category="lunge"
              draggable="true"
            >
              <div class="input-group-header">
                <button class="input-toggle" type="button">â–¶</button>
                <label for="lungeInput">Lunge</label>
              </div>
              <input id="lungeInput" type="number" min="0" max="4" value="1" />
              <p class="category-tip">
                Tip: click an exercise below to add it directly to today's session.
              </p>
              <ul class="input-library-list" data-category-library="lunge"></ul>
              <div class="inline-hover-detail" data-hover-detail="lunge" style="display:none;"></div>
            </div>

            <div
              class="input-group per-category-group collapsed"
              id="unilateralGroup"
              data-category="unilateral"
              draggable="true"
            >
              <div class="input-group-header">
                <button class="input-toggle" type="button">â–¶</button>
                <label for="unilateralInput">Unilateral</label>
              </div>
              <input id="unilateralInput" type="number" min="0" max="5" value="2" />
              <p class="category-tip">
                Tip: click an exercise below to add it directly to today's session.
              </p>
              <ul class="input-library-list" data-category-library="unilateral"></ul>
              <div class="inline-hover-detail" data-hover-detail="unilateral" style="display:none;"></div>
            </div>

            <div
              class="input-group per-category-group collapsed"
              id="coreGroup"
              data-category="core"
              draggable="true"
            >
              <div class="input-group-header">
                <button class="input-toggle" type="button">â–¶</button>
                <label for="coreInput">Core</label>
              </div>
              <input id="coreInput" type="number" min="0" max="5" value="1" />
              <p class="category-tip">
                Tip: click an exercise below to add it directly to today's session.
              </p>
              <ul class="input-library-list" data-category-library="core"></ul>
              <div class="inline-hover-detail" data-hover-detail="core" style="display:none;"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- RIGHT: RESULTS -->
      <section class="card results-card">
        <div class="card-inner">
          <div class="results-header">
            <h2>Your Strength Session</h2>
            <div class="results-right-actions">
              <button id="copyBtn" class="btn btn-small btn-secondary" type="button">
                ðŸ“‹ Copy workout
              </button>
              <button id="saveSessionBtn" class="btn btn-small btn-secondary" type="button">
                ðŸ’¾ Save
              </button>
              <button id="loadSessionBtn" class="btn btn-small btn-secondary" type="button">
                Load
              </button>
              <button id="clearBtn" class="btn btn-small btn-secondary" type="button">
                âœ– Clear all
              </button>
            </div>
          </div>
          <div id="loadSessionBar" class="load-session-bar" style="display:none;">
            <select id="savedSessionsSelect"></select>
            <button id="confirmLoadSessionBtn" class="btn btn-small" type="button">
              Load selected
            </button>
            <button id="deleteSessionBtn" class="btn btn-small btn-secondary" type="button">
              Delete
            </button>
          </div>
          <div class="results-summary-line" id="resultsSummaryLine">
            No exercises selected yet â€“ change an input and generate.
          </div>
          <div class="results-meta">
            Focus: <span>running performance, stability, durability, and prehab</span>.
            Perform this session 1â€“3Ã— per week, away from your hardest run days.
          </div>

          <div id="results" class="results-list">
            <!-- Filled by JS -->
          </div>

          <div class="legend">
            <span><strong>Lower body strength:</strong> 3â€“4 sets Ã— 6â€“8 reps</span>
            <span><strong>Assistance / unilateral:</strong> 2â€“3 sets Ã— 8â€“12 reps</span>
            <span><strong>Core:</strong> 2â€“3 sets Ã— 20â€“40 s or 8â€“10 reps</span>
            <span><strong>Drills / prehab:</strong> 1â€“2 sets, technique-focused</span>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>

    const tagTooltips = {
      "Strength": "Heavier, slower work to build force and resilience.",
      "Assistance": "Lighter support work to build muscle and groove technique.",
      "Stability": "Control and balance under load or movement.",
      "Power": "Crisp, explosive movements with full control.",
      "Drill": "Running-specific pattern work; stay smooth and rhythmic.",
      "Prehab": "Joint and tissue care to stay ahead of injuries.",
      "Core": "Trunk control to keep posture and pelvis stable.",
      "Hinge": "Hip-dominant pattern; focus on hips moving back."
    };

    const exercises = {
      squat: [
        {
          name: "goblet squat",
          sets: "3â€“4",
          reps: "6â€“8",
          note: "Controlled tempo, focus on depth and bracing.",
          tags: ["Strength"]
        }
      ],
      hinge: [
        {
          name: "hamstring walkouts",
          sets: "3â€“4",
          reps: "6â€“8",
          note: "Hamstring and glute focus; maintain flat back, slowly extend legs.",
          tags: ["Strength"]
        },
        {
          name: "glute bridge",
          sets: "3",
          reps: "10â€“12",
          note: "Pause 1â€“2 s at the top for glute squeeze.",
          tags: ["Assistance"]
        },
        {
          name: "hip thrusts",
          sets: "3â€“4",
          reps: "8â€“10",
          note: "Drive through heels, keep ribs down.",
          tags: ["Strength"]
        },
        {
          name: "hip raises",
          sets: "2â€“3",
          reps: "10â€“12 / side",
          note: "Stand on one leg. Smooth lift and lower; focus on glute activation.",
          tags: ["Assistance"]
        },
        {
          name: "clamshells",
          sets: "2â€“3",
          reps: "10â€“15 / side",
          note: "Slow open/close; feel the work in the outer hip, not the low back.",
          tags: ["Prehab", "Stability", "Hinge"]
        }
      ],
      // New Lunge category with four lunge exercises
      lunge: [
        {
          name: "lunge with weights",
          sets: "2â€“3",
          reps: "8â€“10 / leg",
          note: "Maintain upright torso; control descent.",
          tags: ["Stability", "Drill"]
        },
        {
          name: "lunge circuit",
          sets: "2â€“3",
          reps: "4â€“6 reps of each lunge variation",
          note: "Use one weight, move down and up, walk. Add turns to side.",
          tags: ["Stability", "Drill"]
        },
        {
          name: "lunge with hinge",
          sets: "2â€“3",
          reps: "6â€“8 / leg",
          note: "Knee on ground. Move hand of back leg down to the ground. Other hand holds weight above head.",
          tags: ["Stability", "Hinge"]
        },
        {
          name: "lunge to hip drive",
          sets: "2â€“3",
          reps: "6â€“8 / leg",
          note: "Drive the knee up powerfully out of the lunge.",
          tags: ["Power", "Drill"]
        }
      ],
      unilateral: [
        {
          name: "step-ups",
          sets: "3",
          reps: "8â€“10 / leg",
          note: "Slow lower, control knee alignment.",
          tags: ["Stability"]
        },
        {
          name: "single leg romanian deadlift",
          sets: "3",
          reps: "6â€“8 / leg",
          note: "Balance + posterior chain; move slowly.",
          tags: ["Stability", "Strength"]
        },
        {
          name: "hip lock knee drive",
          sets: "2â€“3",
          reps: "6â€“8 / leg",
          note: "Pause briefly in the hip lock, tall posture.",
          tags: ["Drill", "Stability"]
        },
        {
          name: "single leg glute bridge",
          sets: "2â€“3",
          reps: "8â€“10 / leg",
          note: "Elevate shoulders or foot; focus on controlled hip drive.",
          tags: ["Stability", "Assistance"]
        },
        {
          name: "single leg calf raises",
          sets: "2â€“3",
          reps: "10â€“15 / leg",
          note: "Controlled up, slow down; keep hips level and steady.",
          tags: ["Stability", "Prehab"]
        }
      ],
      plyo: [
        {
          name: "pogos double leg",
          sets: "2â€“3",
          reps: "15â€“20 contacts",
          note: "Quick, light contacts; think â€œspringyâ€.",
          tags: ["Power"]
        },
        {
          name: "pogos single leg",
          sets: "2â€“3",
          reps: "10â€“12 contacts / leg",
          note: "Quick, light contacts; think â€œspringyâ€.",
          tags: ["Power"]
        },
        {
          name: "skipping",
          sets: "2â€“3",
          reps: "20â€“30 m",
          note: "Drive knee up, rhythmic arm swing.",
          tags: ["Power", "Drill"]
        },
        {
          name: "line hops",
          sets: "2â€“3",
          reps: "20â€“30 hops",
          note: "Small, fast hops over a line; stay relaxed.",
          tags: ["Power"]
        }
      ],
      core: [
        {
          name: "dead bug",
          sets: "2â€“3",
          reps: "8â€“10 / side",
          note: "Slow, controlled, low back stays on floor.",
          tags: ["Core"]
        },
        {
          name: "bird dog pose",
          sets: "2â€“3",
          reps: "8â€“10 / side",
          note: "Extend opposite arm and leg; keep hips level.",
          tags: ["Core"]
        },
        {
          name: "knee push opposite arm",
          sets: "2â€“3",
          reps: "8â€“10 / side",
          note: "Push knee and opposite arm against each other; other leg is extended.",
          tags: ["Core"]
        },
        {
          name: "side plank",
          sets: "2â€“3",
          reps: "20â€“35 s / side",
          note: "Straight line from ear to ankle; no sagging.",
          tags: ["Core", "Stability"]
        },
        {
          name: "plank",
          sets: "2â€“3",
          reps: "25â€“40 s",
          note: "Ribs down, glutes tight, neutral neck.",
          tags: ["Core"]
        }
      ],
      drills: [
        {
          name: "heel walks",
          sets: "1â€“2",
          reps: "15â€“25 m",
          note: "Walk on heels, toes up; focus on shin and ankle control.",
          tags: ["Drill", "Prehab"]
        },
        {
          name: "calf walks",
          sets: "1â€“2",
          reps: "15â€“25 m",
          note: "Walk on toes, slow and controlled, tall posture.",
          tags: ["Drill", "Prehab"]
        },
        {
          name: "theraband routine (ankles)",
          sets: "1â€“2",
          reps: "10â€“15 each direction",
          note: "Slow ankle motions in all directions against the band.",
          tags: ["Prehab"]
        }
      ]
    };

    // Global current workout state
    let currentWorkout = {
      squat: [],
      hinge: [],
      lunge: [],
      unilateral: [],
      plyo: [],
      core: [],
      drills: []
    };

    const SESSIONS_KEY = "runner-strength-sessions-v1";

    function getSavedSessions() {
      const raw = localStorage.getItem(SESSIONS_KEY);
      if (!raw) return [];
      try {
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch {
        return [];
      }
    }

    function saveSessionsToStorage(sessions) {
      localStorage.setItem(SESSIONS_KEY, JSON.stringify(sessions));
    }

    function populateSavedSessionsSelect() {
      const select = document.getElementById("savedSessionsSelect");
      if (!select) return;

      const sessions = getSavedSessions();
      select.innerHTML = "";

      if (!sessions.length) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "No saved sessions yet";
        select.appendChild(opt);
        select.disabled = true;
        return;
      }

      select.disabled = false;

      // Sort by name for now (could also sort by createdAt)
      sessions
        .slice()
        .sort((a, b) => a.name.localeCompare(b.name))
        .forEach(session => {
          const opt = document.createElement("option");
          opt.value = session.id;
          opt.textContent = session.name;
          select.appendChild(opt);
        });
    }

    function saveCurrentSession() {
      // Make sure there is something to save
      const counts = updateCountsFromCurrent();
      const totalCount =
        counts.squat +
        counts.hinge +
        counts.lunge +
        counts.unilateral +
        counts.plyo +
        counts.core +
        counts.drills;

      if (totalCount === 0) {
        alert("No exercises in this session to save yet.");
        return;
      }

      const name = prompt("Name this session:", "Strength session");
      if (!name) return; // cancelled or empty

      const sessions = getSavedSessions();
      const order = getCategoryOrderFromSetup();

      // If a session with this name exists, offer to overwrite
      const existingIndex = sessions.findIndex(s => s.name === name);

      const newSession = {
        id: existingIndex >= 0 && sessions[existingIndex].id
          ? sessions[existingIndex].id
          : Date.now().toString(),
        name,
        createdAt: Date.now(),
        counts,
        workout: currentWorkout,
        order
      };

      if (existingIndex >= 0) {
        const ok = confirm(`Replace existing session "${name}"?`);
        if (!ok) return;
        sessions[existingIndex] = newSession;
      } else {
        sessions.push(newSession);
      }

      saveSessionsToStorage(sessions);
      populateSavedSessionsSelect();
      alert(`Session "${name}" saved.`);
    }

    function loadSelectedSession() {
      const select = document.getElementById("savedSessionsSelect");
      if (!select || select.disabled) return;

      const id = select.value;
      if (!id) {
        alert("No saved session selected.");
        return;
      }

      const sessions = getSavedSessions();
      const session = sessions.find(s => s.id === id);
      if (!session) {
        alert("Could not find that saved session.");
        return;
      }

      // Restore workout + counts
      currentWorkout = session.workout || {
        squat: [],
        hinge: [],
        lunge: [],
        unilateral: [],
        plyo: [],
        core: [],
        drills: []
      };

      const counts = session.counts || updateCountsFromCurrent();

      // Restore per-category inputs
      document.getElementById("squatInput").value = counts.squat ?? 0;
      document.getElementById("hingeInput").value = counts.hinge ?? 0;
      document.getElementById("lungeInput").value = counts.lunge ?? 0;
      document.getElementById("unilateralInput").value = counts.unilateral ?? 0;
      document.getElementById("plyoInput").value = counts.plyo ?? 0;
      document.getElementById("coreInput").value = counts.core ?? 0;
      document.getElementById("drillsInput").value = counts.drills ?? 0;

      // Restore category order if present
      if (session.order && Array.isArray(session.order)) {
        const container = document.getElementById("inputsColumn");
        session.order.forEach(catKey => {
          const group = document.querySelector(`.per-category-group[data-category="${catKey}"]`);
          if (group && container) {
            container.appendChild(group);
          }
        });
      }

      // Re-render results
      renderResults({
        error: "",
        data: currentWorkout,
        counts,
        mode: "perCategory"
      });
    }

    function deleteSelectedSession() {
      const select = document.getElementById("savedSessionsSelect");
      if (!select || select.disabled) return;

      const id = select.value;
      if (!id) {
        alert("No saved session selected.");
        return;
      }

      const sessions = getSavedSessions();
      const session = sessions.find(s => s.id === id);
      if (!session) {
        alert("Could not find that saved session.");
        return;
      }

      const ok = confirm(`Delete session "${session.name}"? This cannot be undone.`);
      if (!ok) return;

      const remaining = sessions.filter(s => s.id !== id);
      saveSessionsToStorage(remaining);
      populateSavedSessionsSelect();
    }

    function getRandomSubset(arr, count) {
      const copy = [...arr];
      for (let i = copy.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      return copy.slice(0, count);
    }

    function getCategoryOrderFromSetup() {
      const groups = document.querySelectorAll(".per-category-group");
      const order = [];
      groups.forEach(g => {
        const cat = g.getAttribute("data-category");
        if (cat) order.push(cat);
      });
      return order;
    }

    function validatePerCategory(values) {
      const config = [
        { key: "squat", label: "Squat", max: exercises.squat.length },
        { key: "hinge", label: "Hinge", max: exercises.hinge.length },
        { key: "lunge", label: "Lunge", max: exercises.lunge.length },
        { key: "unilateral", label: "Unilateral", max: exercises.unilateral.length },
        { key: "plyo", label: "Plyometric", max: exercises.plyo.length },
        { key: "core", label: "Core", max: exercises.core.length },
        { key: "drills", label: "Drills / Prehab", max: exercises.drills.length }
      ];

      for (const { key, label, max } of config) {
        const n = values[key];
        if (Number.isNaN(n) || n < 0 || n > max) {
          return `${label} exercises must be between 0 and ${max}.`;
        }
      }
      return "";
    }

    function generatePerCategoryWorkout() {
      const squatCount = parseInt(document.getElementById("squatInput").value, 10) || 0;
      const hingeCount = parseInt(document.getElementById("hingeInput").value, 10) || 0;
      const lungeCount = parseInt(document.getElementById("lungeInput").value, 10) || 0;
      const unilateralCount = parseInt(document.getElementById("unilateralInput").value, 10) || 0;
      const plyoCount = parseInt(document.getElementById("plyoInput").value, 10) || 0;
      const coreCount = parseInt(document.getElementById("coreInput").value, 10) || 0;
      const drillsCount = parseInt(document.getElementById("drillsInput").value, 10) || 0;

      const values = {
        squat: squatCount,
        hinge: hingeCount,
        lunge: lungeCount,
        unilateral: unilateralCount,
        plyo: plyoCount,
        core: coreCount,
        drills: drillsCount
      };

      const validationError = validatePerCategory(values);
      if (validationError) {
        return { error: validationError, data: null, counts: values, mode: "PerCategory" };
      }

      const data = {};
      Object.entries(values).forEach(([catKey, count]) => {
        const library = exercises[catKey] || [];
        const previous = currentWorkout[catKey] || [];
        const pinned = previous.filter(ex => ex.pinned);
        const pinnedNames = new Set(pinned.map(ex => ex.name));

        // If user pinned more than requested count, just keep the first "count"
        const effectivePinned = pinned.slice(0, count);
        const remainingNeeded = Math.max(count - effectivePinned.length, 0);

        const pool = library.filter(ex => !pinnedNames.has(ex.name));
        const random = getRandomSubset(pool, remainingNeeded).map(ex => ({
          name: ex.name,
          sets: ex.sets,
          reps: ex.reps,
          note: ex.note,
          tags: ex.tags,
          pinned: false
        }));

        data[catKey] = [...effectivePinned, ...random];
      });

      return { error: "", data, counts: values, mode: "perCategory" };
    }

    function regenerateCategory(categoryKey) {
      const mode = "perCategory";
      const library = exercises[categoryKey] || [];
      if (!library.length) return;

      const previous = currentWorkout[categoryKey] || [];
      const pinned = previous.filter(ex => ex.pinned);
      const pinnedNames = new Set(pinned.map(ex => ex.name));

      const input = document.getElementById(categoryKey + "Input");
      const desiredCount = input ? (parseInt(input.value, 10) || 0) : previous.length;

      const remainingNeeded = Math.max(desiredCount - pinned.length, 0);
      const pool = library.filter(ex => !pinnedNames.has(ex.name));
      const random = getRandomSubset(pool, remainingNeeded).map(ex => ({
        name: ex.name,
        sets: ex.sets,
        reps: ex.reps,
        note: ex.note,
        tags: ex.tags,
        pinned: false
      }));

      currentWorkout[categoryKey] = [...pinned.slice(0, desiredCount), ...random];

      const counts = updateCountsFromCurrent();
      renderResults({
        error: "",
        data: currentWorkout,
        counts,
        mode
      });
    }

    function updateCountsFromCurrent() {
      return {
        squat: currentWorkout.squat.length,
        hinge: currentWorkout.hinge.length,
        lunge: currentWorkout.lunge.length,
        unilateral: currentWorkout.unilateral.length,
        plyo: currentWorkout.plyo.length,
        core: currentWorkout.core.length,
        drills: currentWorkout.drills.length
      };
    }

    function renderResults(resultObject) {
      const { error, data, counts } = resultObject;
      const errorDiv = document.getElementById("error");
      const resultsDiv = document.getElementById("results");
      const summaryLine = document.getElementById("resultsSummaryLine");
      const modeText = document.getElementById("modeText");

      if (error) {
        errorDiv.textContent = error;
        errorDiv.style.display = "block";
        resultsDiv.innerHTML = "";
        summaryLine.textContent = "Fix the inputs to generate a session.";
        return;
      } else {
        errorDiv.textContent = "";
        errorDiv.style.display = "none";
      }

      // Sync global state
      currentWorkout = data;

      if (modeText) {
        modeText.textContent = "Per-category";
      }

      resultsDiv.innerHTML = "";

      const totalExercises =
        counts.squat +
        counts.hinge +
        counts.lunge +
        counts.unilateral +
        counts.plyo +
        counts.core +
        counts.drills;

      if (totalExercises === 0) {
        summaryLine.textContent = "No exercises selected yet â€“ change an input and generate.";
      } else {
        const baseSummary =
          `${totalExercises} exercises selected â€¢ ` +
          `Squat ${counts.squat}, Hinge ${counts.hinge}, Lunge ${counts.lunge}, ` +
          `Uni ${counts.unilateral}, Plyo ${counts.plyo}, Core ${counts.core}, Drills ${counts.drills}`;
        summaryLine.textContent = baseSummary;
      }

      const categoryLabels = {
        squat: "Squat pattern",
        hinge: "Hinge pattern",
        lunge: "Lunge pattern",
        unilateral: "Unilateral",
        plyo: "Plyometric",
        core: "Core",
        drills: "Drills / Prehab"
      };

      function renderCategory(label, key, items) {
        const block = document.createElement("div");
        block.className = "category-block";

        const header = document.createElement("div");
        header.className = "category-header";

        const name = document.createElement("div");
        name.className = "category-name";
        name.textContent = label;

        const pill = document.createElement("div");
        pill.className = "category-pill";
        pill.textContent = items.length === 0
          ? "0 selected"
          : `${items.length} exercise${items.length > 1 ? "s" : ""}`;

        const headerRight = document.createElement("div");
        headerRight.className = "category-header-right";

        const regenBtn = document.createElement("button");
        regenBtn.type = "button";
        regenBtn.className = "category-regenerate";
        regenBtn.textContent = "â†»";
        regenBtn.title = "Regenerate this category";
        regenBtn.addEventListener("click", () => {
          regenerateCategory(key);
        });

        headerRight.appendChild(pill);
        headerRight.appendChild(regenBtn);

        header.appendChild(name);
        header.appendChild(headerRight);

        block.appendChild(header);

        if (items.length === 0) {
          const empty = document.createElement("div");
          empty.className = "category-empty";
          empty.textContent = "No exercises selected in this category.";
          block.appendChild(empty);
        } else {
          const ul = document.createElement("ul");
          ul.className = "exercise-list";

          items.forEach((ex, index) => {
            const li = document.createElement("li");
            li.className = "exercise-item";

            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.className = "exercise-checkbox";
            checkbox.addEventListener("change", () => {
              li.classList.toggle("done", checkbox.checked);
            });

            const content = document.createElement("div");
            content.className = "exercise-content";

            const mainLineWrap = document.createElement("div");
            mainLineWrap.className = "exercise-main-line";

            const mainLine = document.createElement("span");
            mainLine.className = "exercise-main";
            mainLine.textContent = ex.name;

            const tagsWrapper = document.createElement("span");
            tagsWrapper.className = "exercise-tags";

            if (ex.tags && ex.tags.length > 0) {
              ex.tags.forEach(tagText => {
                const tag = document.createElement("span");
                tag.className = "exercise-tag";
                tag.textContent = tagText;
                if (tagTooltips[tagText]) {
                  tag.setAttribute("data-tooltip", tagTooltips[tagText]);
                }
                tagsWrapper.appendChild(tag);
              });
            }

            const removeBtn = document.createElement("button");
            removeBtn.className = "exercise-remove";
            removeBtn.type = "button";
            removeBtn.textContent = "Ã—";
            removeBtn.title = "Remove from workout";
            removeBtn.addEventListener("click", () => {
              removeExerciseFromWorkout(key, index);
            });
            // Pin button
            const pinBtn = document.createElement("button");
            pinBtn.type = "button";
            pinBtn.className = "exercise-pin";
            pinBtn.textContent = ex.pinned ? "â˜…" : "â˜†";
            pinBtn.title = ex.pinned
              ? "Pinned (kept when regenerating)"
              : "Pin (keep when regenerating)";
            pinBtn.addEventListener("click", (e) => {
              e.stopPropagation();
              ex.pinned = !ex.pinned;
              pinBtn.textContent = ex.pinned ? "â˜…" : "â˜†";
              pinBtn.title = ex.pinned
                ? "Pinned (kept when regenerating)"
                : "Pin (keep when regenerating)";
              li.classList.toggle("pinned", ex.pinned);
            });

            li.classList.toggle("pinned", !!ex.pinned);

            // Wrap text (name + tags) so it stays together
            const textWrap = document.createElement("div");
            textWrap.className = "exercise-text-wrap";
            textWrap.appendChild(mainLine);
            textWrap.appendChild(tagsWrapper);

            // Wrap actions (pin + remove) so they stay together
            const actionsWrap = document.createElement("div");
            actionsWrap.className = "exercise-actions";
            actionsWrap.appendChild(pinBtn);
            actionsWrap.appendChild(removeBtn);

            mainLineWrap.appendChild(textWrap);
            mainLineWrap.appendChild(actionsWrap);

            const detail = document.createElement("span");
            detail.className = "exercise-detail";
            detail.textContent = `${ex.sets} sets Ã— ${ex.reps}  â€¢  ${ex.note}`;

            content.appendChild(mainLineWrap);
            content.appendChild(detail);

            li.appendChild(checkbox);
            li.appendChild(content);
            ul.appendChild(li);
          });

          block.appendChild(ul);
        }

        resultsDiv.appendChild(block);
      }

      const order = getCategoryOrderFromSetup();
      order.forEach(catKey => {
        renderCategory(categoryLabels[catKey], catKey, data[catKey]);
      });
    }

    function removeExerciseFromWorkout(categoryKey, index) {
      if (!currentWorkout[categoryKey]) return;
      currentWorkout[categoryKey].splice(index, 1);

      const counts = updateCountsFromCurrent();

      renderResults({
        error: "",
        data: currentWorkout,
        counts,
        mode: "perCategory"
      });
    }

    function addExerciseToWorkout(categoryKey, exerciseObj) {
      if (!currentWorkout[categoryKey]) {
        currentWorkout[categoryKey] = [];
      }
      const alreadyExists = currentWorkout[categoryKey].some(ex => ex.name === exerciseObj.name);
      if (alreadyExists) return;

      currentWorkout[categoryKey].push({
        name: exerciseObj.name,
        sets: exerciseObj.sets,
        reps: exerciseObj.reps,
        note: exerciseObj.note,
        tags: exerciseObj.tags,
        pinned: false
      });

      const counts = updateCountsFromCurrent();

      renderResults({
        error: "",
        data: currentWorkout,
        counts,
        mode: "perCategory"
      });
    }

    function renderInlineLibraries() {
      const categories = ["squat", "hinge", "lunge", "unilateral", "plyo", "core", "drills"];
      categories.forEach(catKey => {
        const ul = document.querySelector(`.input-library-list[data-category-library="${catKey}"]`);
        const hoverBox = document.querySelector(`.inline-hover-detail[data-hover-detail="${catKey}"]`);
        if (!ul || !hoverBox) return;

        ul.innerHTML = "";
        const catExercises = exercises[catKey] || [];
        catExercises.forEach(ex => {
          const li = document.createElement("li");
          li.className = "input-library-item";

          const nameSpan = document.createElement("span");
          nameSpan.className = "input-library-name";
          nameSpan.textContent = ex.name;

          const tagsSpan = document.createElement("span");
          tagsSpan.className = "input-library-tags";
          tagsSpan.textContent = ex.tags && ex.tags.length ? ex.tags.join(", ") : "";

          li.appendChild(nameSpan);
          li.appendChild(tagsSpan);

          // Only enable hover previews on devices that actually support hover
          const allowHoverPreview =
            window.matchMedia &&
            window.matchMedia("(hover: hover) and (pointer: fine)").matches;

          if (allowHoverPreview) {
            li.addEventListener("mouseenter", () => {
              hoverBox.style.display = "block";
              hoverBox.innerHTML = "";

              const titleEl = document.createElement("div");
              titleEl.className = "inline-hover-title";
              titleEl.textContent = ex.name;

              const metaEl = document.createElement("div");
              metaEl.className = "inline-hover-meta";
              metaEl.textContent = `${ex.sets} sets Ã— ${ex.reps}` +
                (ex.tags && ex.tags.length ? ` â€¢ ${ex.tags.join(", ")}` : "");

              const noteEl = document.createElement("div");
              noteEl.className = "inline-hover-note";
              noteEl.textContent = ex.note;

              hoverBox.appendChild(titleEl);
              hoverBox.appendChild(metaEl);
              hoverBox.appendChild(noteEl);
            });

            li.addEventListener("mouseleave", () => {
              hoverBox.style.display = "none";
            });
          } else {
            // On touch/mobile: make sure it's hidden
            hoverBox.style.display = "none";
          }

          // Click: add to workout (works on both desktop & mobile)
          li.addEventListener("click", () => {
            addExerciseToWorkout(catKey, ex);
          });

          ul.appendChild(li);
        });
      });
    }

    function clearWorkout() {
      // Reset global workout state
      currentWorkout = {
        squat: [],
        hinge: [],
        lunge: [],
        unilateral: [],
        plyo: [],
        core: [],
        drills: []
      };

      // All counts back to 0
      const counts = {
        squat: 0,
        hinge: 0,
        lunge: 0,
        unilateral: 0,
        plyo: 0,
        core: 0,
        drills: 0
      };

      // Re-render (per-category only)
      renderResults({
        error: "",
        data: currentWorkout,
        counts,
        mode: "perCategory"
      });
    }

    function generateWorkout() {
      const result = generatePerCategoryWorkout();
      renderResults(result);
    }

    function applyRunnerPreset() {
      // By default: 1 lunge, 2 unilateral, others like your old preset
      document.getElementById("drillsInput").value = 2;
      document.getElementById("squatInput").value = 1;
      document.getElementById("hingeInput").value = 2;
      document.getElementById("lungeInput").value = 1;
      document.getElementById("unilateralInput").value = 2;
      document.getElementById("plyoInput").value = 1;
      document.getElementById("coreInput").value = 1;
    }

    function copyWorkoutToClipboard() {
      const resultsDiv = document.getElementById("results");
      const categoryBlocks = resultsDiv.querySelectorAll(".category-block");
      if (!categoryBlocks.length) return;

      let text = "Runner Strength Session\n\n";

      categoryBlocks.forEach(block => {
        const title = block.querySelector(".category-name")?.textContent || "";
        const items = block.querySelectorAll(".exercise-item");
        if (!items.length) return;
        text += title + ":\n";
        items.forEach(item => {
          const checkbox = item.querySelector(".exercise-checkbox");
          const doneMark = checkbox && checkbox.checked ? "[x]" : "[ ]";
          const name = item.querySelector(".exercise-main")?.textContent || "";
          const detail = item.querySelector(".exercise-detail")?.textContent || "";
          text += `  ${doneMark} ${name} â€” ${detail}\n`;
        });
        text += "\n";
      });

      navigator.clipboard.writeText(text).then(() => {
        const copyBtn = document.getElementById("copyBtn");
        const originalText = copyBtn.textContent;
        copyBtn.textContent = "Copied!";
        setTimeout(() => {
          copyBtn.textContent = originalText;
        }, 1500);
      }).catch(() => {
        alert("Could not copy to clipboard in this browser.");
      });
    }

    function initDragAndDrop() {
      const container = document.getElementById("inputsColumn");
      let dragSrcEl = null;

      function handleDragStart(e) {
        dragSrcEl = e.currentTarget;
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/plain", dragSrcEl.id);
      }

      function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";
        const target = e.currentTarget;
        if (target === dragSrcEl) return;
        target.classList.add("drag-over");
      }

      function handleDragLeave(e) {
        e.currentTarget.classList.remove("drag-over");
      }

      function handleDrop(e) {
        e.preventDefault();
        const target = e.currentTarget;
        target.classList.remove("drag-over");
        if (dragSrcEl === target) return;

        const groups = Array.from(container.querySelectorAll(".per-category-group"));
        const dragIndex = groups.indexOf(dragSrcEl);
        const dropIndex = groups.indexOf(target);

        if (dragIndex < 0 || dropIndex < 0) return;

        if (dragIndex < dropIndex) {
          container.insertBefore(dragSrcEl, target.nextSibling);
        } else {
          container.insertBefore(dragSrcEl, target);
        }
      }

      function handleDragEnd() {
        const groups = container.querySelectorAll(".per-category-group");
        groups.forEach(g => g.classList.remove("drag-over"));
      }

      const groups = container.querySelectorAll(".per-category-group");
      groups.forEach(group => {
        group.addEventListener("dragstart", handleDragStart);
        group.addEventListener("dragover", handleDragOver);
        group.addEventListener("dragleave", handleDragLeave);
        group.addEventListener("drop", handleDrop);
        group.addEventListener("dragend", handleDragEnd);
      });
    }

    function initThemeToggle() {
      const body = document.body;
      const toggle = document.getElementById("themeToggle");
      const label = document.getElementById("themeLabel");

      const stored = localStorage.getItem("runner-strength-theme");
      if (stored === "light") {
        body.setAttribute("data-theme", "light");
        toggle.checked = true;
        label.textContent = "Light";
      } else {
        body.setAttribute("data-theme", "dark");
        toggle.checked = false;
        label.textContent = "Dark";
      }

      toggle.addEventListener("change", () => {
        if (toggle.checked) {
          body.setAttribute("data-theme", "light");
          localStorage.setItem("runner-strength-theme", "light");
          label.textContent = "Light";
        } else {
          body.setAttribute("data-theme", "dark");
          localStorage.setItem("runner-strength-theme", "dark");
          label.textContent = "Dark";
        }
      });
    }

    function initLayoutToggle() {
      const body = document.body;
      const toggle = document.getElementById("layoutToggle");
      const label = document.getElementById("layoutLabel");

      const stored = localStorage.getItem("runner-strength-layout");
      if (stored === "stacked") {
        body.setAttribute("data-layout", "stacked");
        toggle.checked = true;
        label.textContent = "Stacked";
      } else {
        body.setAttribute("data-layout", "wide");
        toggle.checked = false;
        label.textContent = "Wide";
      }

      toggle.addEventListener("change", () => {
        if (toggle.checked) {
          body.setAttribute("data-layout", "stacked");
          localStorage.setItem("runner-strength-layout", "stacked");
          label.textContent = "Stacked";
        } else {
          body.setAttribute("data-layout", "wide");
          localStorage.setItem("runner-strength-layout", "wide");
          label.textContent = "Wide";
        }
      });
    }

    document.getElementById("generateBtn").addEventListener("click", generateWorkout);
    document.getElementById("presetBtn").addEventListener("click", () => {
      applyRunnerPreset();
      generateWorkout();
    });
    document.getElementById("copyBtn").addEventListener("click", copyWorkoutToClipboard);
    document.getElementById("clearBtn").addEventListener("click", clearWorkout);
    
    document.getElementById("saveSessionBtn").addEventListener("click", saveCurrentSession);

    document.getElementById("loadSessionBtn").addEventListener("click", () => {
      const bar = document.getElementById("loadSessionBar");
      if (!bar) return;
      const isHidden = bar.style.display === "none" || bar.style.display === "";
      if (isHidden) {
        bar.style.display = "flex";
        populateSavedSessionsSelect();
      } else {
        bar.style.display = "none";
      }
    });

    document.getElementById("confirmLoadSessionBtn").addEventListener("click", loadSelectedSession);
    document.getElementById("deleteSessionBtn").addEventListener("click", deleteSelectedSession);

    function initLibraryToggles() {
      const groups = document.querySelectorAll(".per-category-group");

      groups.forEach(group => {
        const toggleBtn = group.querySelector(".input-toggle");
        const header = group.querySelector(".input-group-header");
        if (!toggleBtn || !header) return;

        // Start collapsed: arrow points right
        toggleBtn.textContent = group.classList.contains("collapsed") ? "â–¶" : "â–¼";

        function toggleGroup() {
          const nowCollapsed = group.classList.toggle("collapsed");
          toggleBtn.textContent = nowCollapsed ? "â–¶" : "â–¼";

          // Hide any visible hover details when collapsing
          if (nowCollapsed) {
            const hoverBox = group.querySelector(".inline-hover-detail");
            if (hoverBox) {
              hoverBox.style.display = "none";
            }
          }
        }

        // Click on the arrow itself
        toggleBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          toggleGroup();
        });

        // Click on the whole header (label area) also toggles
        header.addEventListener("click", (e) => {
          // Avoid double-handling if you clicked exactly on the button
          if (e.target === toggleBtn) return;
          toggleGroup();
        });
      });
    }

    window.addEventListener("DOMContentLoaded", () => {
      initThemeToggle();
      initLayoutToggle();
      initDragAndDrop();
      renderInlineLibraries();
      initLibraryToggles();
      clearWorkout();
      populateSavedSessionsSelect();

      // Mobile action bar hooks
    const mobileGenerateBtn = document.getElementById("mobileGenerateBtn");
    const mobilePresetBtn = document.getElementById("mobilePresetBtn");
    const mobileCopyBtn = document.getElementById("mobileCopyBtn");

    if (mobileGenerateBtn) {
      mobileGenerateBtn.addEventListener("click", () => {
        document.getElementById("generateBtn").click();
      });
    }
    if (mobilePresetBtn) {
      mobilePresetBtn.addEventListener("click", () => {
        document.getElementById("presetBtn").click();
      });
    }
    if (mobileCopyBtn) {
      mobileCopyBtn.addEventListener("click", () => {
        document.getElementById("copyBtn").click();
      });
    }
    });
  </script>
  <div class="mobile-action-bar">
    <button id="mobileGenerateBtn" class="btn btn-small"><span class="btn-icon">âš¡</span> Generate</button>
    <button id="mobilePresetBtn" class="btn btn-small btn-secondary">Preset</button>
    <button id="mobileCopyBtn" class="btn btn-small btn-secondary">Copy</button>
  </div>
</body>
</html>
